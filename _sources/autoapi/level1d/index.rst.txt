:mod:`level1d`
==============

.. py:module:: level1d

.. autoapi-nested-parse::

   Created on Mon Jun 17 14:24:10 2019

   Script to generate the C3S CDM Marine level1d data and add external MD (pub47):

   - Read header table and MD and see if there is anything to merge
   - Map MD to CDM with module cdm
   - Merge mapped MD with CDM tables by primary_station_id and save to file with function ``process_table()`` (if nothing to merge, just save the file to level1d...)
   - log, per table, total number of records and those with MD added/updated

   The processing unit is the source-deck monthly set of CDM tables.

   Outputs data to:
       - ``/<data_path>/<release>/<dataset>/level1d/<sid-dck>/table[i]-fileID.psv``

   Outputs quicklook info to:
       - ``/<data_path>/<release>/<dataset>/level1d/quicklooks/<sid-dck>/fileID.json``

   where fileID is ``yyyy-mm-release_tag-update_tag``

   Before processing starts:
       - checks the existence of all io subdirectories in level1c|d -> exits if fails
       - checks the existence of the source table to be converted (header only) -> exits if fails
       - checks the existence of the monthly MD file -> exits if fails
       - removes all level1d products on input file resulting from previous runs

   Inargs:
   -------
   - data_path: marine data path in file system
   - release: release tag
   - update: udpate tag
   - dataset: dataset tag
   - config_path: configuration file path
   - sid_dck: source-deck data partition (optional, from config_file otherwise)
   - year: data file year (yyyy) (optional, from config_file otherwise)
   - month: data file month (mm) (optional, from config_file otherwise)

   On input data:
   --------------
   If the pre-processing of the MD changes, then how we map the MD in ``map_to_cdm()`` changes also.
   The mappings there as for MD pre-processing in Autumn2019:
       - pub47 monthly files assumed to have 1 hdr line (first) with column names
       - pub47 monthly files with FS=';'
       - pub47 field names assumed:

       ``call;record;name;freq;vsslM;vssl;automation;rcnty;``
       ``valid_from;valid_to;uid;thmH1;platH;brmH1;anmH;anHL1;``
       ``wwH;sstD1;th1;hy1;st1;bm1;an1``

   @author: iregon



Module Contents
---------------

Classes
~~~~~~~

.. autoapisummary::

   level1d.script_setup



Functions
~~~~~~~~~

.. autoapisummary::

   level1d.map_to_cdm
   level1d.process_table
   level1d.clean_level



Attributes
~~~~~~~~~~

.. autoapisummary::

   level1d.date_handler
   level1d.args
   level1d.params
   level1d.FFS
   level1d.delimiter
   level1d.md_delimiter
   level1d.level
   level1d.level_prev
   level1d.header
   level1d.wmode
   level1d.release_path
   level1d.release_id
   level1d.fileID
   level1d.fileID_date
   level1d.prev_level_path
   level1d.level_path
   level1d.level_ql_path
   level1d.level_log_path
   level1d.data_paths
   level1d.prev_level_filename
   level1d.md_avail
   level1d.md_path
   level1d.meta_dict
   level1d.history_tstmp
   level1d.cdm_tables
   level1d.obs_tables
   level1d.table
   level1d.header_df
   level1d.header_df
   level1d.meta_df
   level1d.merge
   level1d.meta_df
   level1d.meta_cdm
   level1d.table
   level1d.level_io_filename


.. class:: script_setup(inargs)



.. data:: date_handler
   

   

.. function:: map_to_cdm(md_model, meta_df)


.. function:: process_table(table_df, table_name)


.. function:: clean_level(file_id)


.. data:: args
   

   

.. data:: params
   

   

.. data:: FFS
   :annotation: = -

   

.. data:: delimiter
   :annotation: = |

   

.. data:: md_delimiter
   :annotation: = |

   

.. data:: level
   :annotation: = level1d

   

.. data:: level_prev
   :annotation: = level1c

   

.. data:: header
   :annotation: = True

   

.. data:: wmode
   :annotation: = w

   

.. data:: release_path
   

   

.. data:: release_id
   

   

.. data:: fileID
   

   

.. data:: fileID_date
   

   

.. data:: prev_level_path
   

   

.. data:: level_path
   

   

.. data:: level_ql_path
   

   

.. data:: level_log_path
   

   

.. data:: data_paths
   

   

.. data:: prev_level_filename
   

   

.. data:: md_avail
   

   

.. data:: md_path
   

   

.. data:: meta_dict
   

   

.. data:: history_tstmp
   

   

.. data:: cdm_tables
   

   

.. data:: obs_tables
   

   

.. data:: table
   :annotation: = header

   

.. data:: header_df
   

   

.. data:: header_df
   

   

.. data:: meta_df
   

   

.. data:: merge
   

   

.. data:: meta_df
   

   

.. data:: meta_cdm
   

   

.. data:: table
   :annotation: = header

   

.. data:: level_io_filename
   

   

